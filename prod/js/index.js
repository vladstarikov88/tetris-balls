function controllerEnable(){document.body.onkeydown=function(e){var o={37:"left",39:"right",40:"down",38:"rotate"};void 0!==o[e.keyCode]&&(keyPress(o[e.keyCode]),render())}}
function clearEmpty(r){for(var o=ROWS-1;0<o;o--)for(var a=0;a<COLS;a++)if(0==r[o][a])for(var e=o;0<e;e--)r[e][a]=r[e-1][a];return r}function clearLines(){for(var r=0;r<ROWS;r++)for(var o=0;o<COLS;o++)0!==board[r][o]&&0<o&&0<r&&board[r][o-1]==board[r][o]&&board[r][o+1]==board[r][o]&&(deleteRow(board,r,o),clearEmpty(board));for(r=0;r<ROWS-1;r++)for(o=0;o<COLS;o++)0!==board[r][o]&&0<r&&board[r-1][o]==board[r][o]&&board[r+1][o]==board[r][o]&&(deleteCol(board,r,o),clearEmpty(board))}function deleteRow(r,o,a){return r[o][a-1]=0,r[o][a]=0,r[o][a+1]=0,coins+=3,r}function deleteCol(r,o,a){return r[o-1][a]=0,r[o][a]=0,r[o+1][a]=0,coins+=3,r}
function randomInteger(n,o){return Math.round(n-.5+Math.random()*(o-n+1))}function compareCoins(n,o){return o.coins-n.coins}
var start=document.getElementById("start"),modal=document.getElementById("modal"),results=document.getElementById("results"),results_input=document.getElementById("results_input"),results_show=document.getElementById("results_show"),results_save=document.getElementById("results_save"),endgame=document.getElementById("endgame"),levels=document.getElementById("levels");function saveResults(){if(""==document.cookie)console.log("not found");else{console.log("found");var e=document.cookie.split("; "),t=[];e.forEach(function(e,s){void 0===(e=e.split("="))[1]||t.push({name:e[0],coins:e[1]})}),t.sort(compareCoins),console.log(t);var n=document.createElement("div");t.forEach(function(e,s){if(s<10){var t=document.createElement("div");t.className="modal_results-item",t.innerHTML="<p>"+e.name+"</p><p>"+e.coins+"</p>",n.appendChild(t)}}),console.log(t),console.log(n);var s=document.getElementById("modal_results-res");s.innerHTML="",s.appendChild(n)}}function setGameLevel(){switch(levels.value){case"easy":speed=700;break;case"medium":speed=500,colors.push("orange","purple");break;case"hard":speed=200,colors.push("orange","purple","black","hotpink")}}function endGame(){endgame.classList.remove("dn"),final_result.innerHTML=final_result.innerHTML+": "+coins,saveResults()}start.addEventListener("click",function(){modal.classList.add("dn"),setGameLevel(),newGame(),setInterval(render,30),controllerEnable()}),results_show.addEventListener("click",function(){document.getElementById("results").classList.remove("dn")}),results_save.addEventListener("click",function(){document.cookie=results_input.value+"="+coins,console.log(document.cookie),saveResults(),location.reload()}),saveResults();
function drawBlock(r,c){ctx.fillRect(BLOCK_W*r,BLOCK_H*c,BLOCK_W-1,BLOCK_H-1),ctx.strokeRect(BLOCK_W*r,BLOCK_H*c,BLOCK_W-1,BLOCK_H-1)}function render(){ctx.clearRect(0,0,W,H);for(var r=0;r<COLS;++r)for(var c=0;c<ROWS;++c)board[c][r]&&(ctx.fillStyle=colors[board[c][r]],drawBlock(r,c));ctx.strokeStyle="white";for(c=0;c<len;++c)for(r=0;r<len;++r)current[c][r]&&(ctx.fillStyle=colors[current[c][r]],drawBlock(currentX+r,currentY+c))}
function init(){for(var r=0;r<ROWS;++r){board[r]=[];for(var e=0;e<COLS;++e)board[r][e]=0}}function newShape(){var r=line;current=[];for(var e=0;e<len;e++)itemColor[e]=randomInteger(1,colors.length-1),style[e]=colors[itemColor[e]];for(var n=0;n<len;++n){current[n]=[];for(var t=0;t<1;++t){var a=n;void 0!==r[e=len*n+t]&&r[e]?(current[n][t]=itemColor[a],a++):current[n][t]=0}}console.log(itemColor),currentX=5,currentY=0}function freeze(){for(var r=0;r<len;++r)for(var e=0;e<len;++e)current[r][e]&&(board[r+currentY][e+currentX]=current[r][e])}function rotate(r){var e=[];r.forEach(function(r){return e.push(r[0])}),e=e.splice(-1).concat(e);for(var n=0;n<r.length;n++)r[n][0]=e[n];return r}function keyPress(r){switch(r){case"left":valid(-1)&&--currentX;break;case"right":valid(1)&&++currentX;break;case"down":valid(0,1)&&++currentY;break;case"rotate":var e=rotate(current);valid(0,0,e)&&(current=e)}}function valid(r,e,n){r=r||0,e=e||0,r=currentX+r,e=currentY+e,n=n||current;for(var t=0;t<len;++t)for(var a=0;a<len;++a)if(n[t][a]&&(void 0===board[t+e]||void 0===board[t+e][a+r]||board[t+e][a+r]||a+r<0||t+e>=ROWS||a+r>=COLS))return 1==e&&(lose=!0),!1;return!0}function tick(){if(valid(0,1))++currentY,clearLines(),clearEmpty(board);else{if(freeze(),clearLines(),clearEmpty(board),lose)return endGame(),clearInterval(interval),!1;newShape()}}function newGame(){clearInterval(interval),init(),newShape(),lose=!1,interval=setInterval(tick,speed)}
var lose,interval,current,currentX,currentY,COLS=10,ROWS=20,W=300,H=600,BLOCK_W=W/COLS,BLOCK_H=H/ROWS,canvas=document.getElementsByTagName("canvas")[0],ctx=canvas.getContext("2d"),board=[],line=[1,0,0,1,0,0,1,0,0],len=3,style=[],itemColor=[],colors=["","blue","yellow","red","green"],coins=0,speed=700;